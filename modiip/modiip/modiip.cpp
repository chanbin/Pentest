#include <stdio.h>
#include <string.h>
#define BUFLEN 0x10

int main(int argc, char *argv[]) {
	
	if (argc != 4) {
		printf("usage: %s 127.0.0.1 27015 target.exe\n", argv[0]);
		return 1;
	}
	
	FILE *in, *out;
	char buf[BUFLEN]; // 이미지 읽어오기
	memset(buf, 0, sizeof(buf));
	char ip[BUFLEN] = "255.255.255.255";// 이미지의 값 비교
	char port[BUFLEN] = "27015";
	char modiip[BUFLEN];//인자
	char modiport[BUFLEN];
	memset(modiip, 0, sizeof(modiip));
	memset(modiport, 0, sizeof(modiport));
	int num=0,err=0;

	// client.exe 파일 open
	err = fopen_s(&in ,"client.exe", "rb");
	if (err != 0) {
		printf("client.exe file not found!\n");
		return 1;
	}

	// target 파일 open
	err = fopen_s(&out, argv[3], "wb");
	if (err != 0) {
		printf("%s file not found!\n",argv[1]);
		fclose(in);
		return 1;
	}

	// IP 값 받아오기
	if (strlen(argv[1]) > 6 && strlen(argv[1]) < BUFLEN)
		strncat_s(modiip,BUFLEN,argv[1],strlen(argv[1]));
	else {
		printf("Re-enter IP\n");
		fclose(in);
		fclose(out);
		return 1;
	}

	// port 값 받아오기
	if (strlen(argv[2]) > 0 && strlen(argv[2]) < 6)
		strncat_s(modiport, BUFLEN, argv[2], strlen(argv[2]));
	else {
		printf("Re-enter Port\n");
		fclose(in);
		fclose(out);
		return 1;
	}

	// Modify
	while ((num = fread(buf, sizeof(char), BUFLEN, in)) > 0) {
		if (memcmp(buf, ip, BUFLEN) == 0)
			fwrite(modiip, sizeof(char), BUFLEN, out);
		else if (memcmp(buf, port, 6) == 0) {
			fwrite(modiport, sizeof(char), 6, out);
			fwrite(buf+6, sizeof(char), 10, out);
		}
		else
			fwrite(buf, sizeof(char), num, out);
		memset(buf, 0, sizeof(buf));
	}

	fclose(in);
	fclose(out);

	return 0;
}